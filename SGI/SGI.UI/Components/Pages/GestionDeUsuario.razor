@page "/GestionDeUsuario"
@rendermode InteractiveServer
@inject NavigationManager Navigation
@inject CasoDeUsoUsuarioBaja usuarioBaja
@inject MostrarUsuarios verusuarios
@inject CasoDeUsoUsuarioModificar usuarioModificar

<PageTitle>Gestión de Usuarios</PageTitle> 

<div class="contenedor">
    <h1>Gestión de Usuarios</h1>

    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Nombre</th>
                <th>Apellido</th>
                <th>Email</th>
                <th>Permisos</th>
                <th>Acciones</th>
            </tr>
        </thead>

        <tbody>
            @foreach (var usuario in verusuarios.Ejecutar())
            {
                <tr>
                    <td>@usuario.IdUsuario</td>
                    <td>@usuario.Nombre</td>
                    <td>@usuario.Apellido</td>
                    <td>@usuario.Email</td>
                    <td><ul>
                        @foreach (var item in usuario.Permisos)
                        {
                            <span>@item ,</span> 
                        }
                    </ul></td>
                    <td>
                        <button class="btn btn-danger" @onclick="() => eliminar(usuario.Email!)">
                            Eliminar
                        </button>
                        <button class="btn btn-primary" @onclick="() => EditarUsuario(usuario)">
                            Editar
                        </button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

<!-- Modal de modificación de usuario -->
<div class="modal" style="display:@(mostrarModificar ? "flex" : "none")">
    <div class="modal-content">
        <h2>Modificar Usuario</h2>
        <div>
            <label for="nombre">Nombre:</label>
            <input type="text" id="nombre" @bind="nombre" />
        </div>
        <div>
            <label for="apellido">Apellido:</label>
            <input type="text" id="apellido" @bind="apellido" />
        </div>
        <div>
            <label for="email">Email:</label>
            <input type="email" id="email" @bind="email" />
        </div>
        <div>
            <label for="password">Nueva Contraseña (opcional):</label>
            <input type="password" id="password" @bind="password" />
        </div>
        <button @onclick="() => GuardarCambios(idUsuario, nombre, apellido, email, password, permisos)">
            Guardar Cambios
        </button>
        <button @onclick="CerrarModal">Cancelar</button>
        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="error-message">
                @errorMessage
            </div>
        }
    </div>
    
</div>

@code {
    private bool mostrarModificar = false;
    private string? apellido;
    private string? nombre;
    private string? email;
    private string? password;
    private int? idUsuario;


    private List <Permiso.Permisos> permisos;

    private string? errorMessage;

    private void EditarUsuario(Usuario usuario)
    {
        // Rellenamos los datos del usuario en el modal
        idUsuario = usuario.IdUsuario;
        nombre = usuario.Nombre;
        apellido = usuario.Apellido;
        email = usuario.Email;
        password = ""; // Limpiamos la contraseña por si no se quiere modificar
        mostrarModificar = true;
    }

    private void CerrarModal()
    {
        mostrarModificar = false;
    }

    public void GuardarCambios(int? idUsuario,string nombre, string apellido, string email, string password, List<Permiso.Permisos>? permisos){
        try{
            usuarioModificar.Ejecutar(idUsuario, nombre, apellido, email, password, permisos);
            CerrarModal();
        }catch(RepositorioException ex){
            errorMessage = ex.Message;
        }
    }

    private void eliminar(string email)
    {
        usuarioBaja.Ejecutar(email);
    }
}
